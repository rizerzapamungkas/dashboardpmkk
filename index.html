<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pengiriman Laporan - P4OP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { background-color: #f8fafc; font-family: 'Plus Jakarta Sans', sans-serif; color: #1e293b; }
        
        /* Dropdown Search */
        .ts-wrapper .ts-control { 
            border-radius: 0.75rem !important; 
            padding: 0 12px 0 45px !important; 
            border: 1px solid #e2e8f0 !important;
            min-height: 52px !important;
            display: flex; align-items: center; font-size: 15px !important;
        }

        .search-container { position: relative; }
        .search-container::before {
            content: ""; position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
            width: 22px; height: 22px; z-index: 10; pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
        }

        /* Tabel - Diperbesar Ukuran Fontnya */
        table { table-layout: fixed; width: 100%; border-collapse: collapse; }
        th { vertical-align: middle !important; text-align: center !important; font-size: 13px !important; }
        td { 
            vertical-align: middle !important; 
            word-wrap: break-word; 
            overflow-wrap: break-word; 
            white-space: normal !important; 
            padding: 14px 10px !important; /* Padding ditambah agar lebih lega */
            font-size: 15px !important; /* Font isi tabel diperbesar */
        }
        
        .w-no { width: 55px; } 
        .w-mhs { width: 23%; }
        .w-prodi { width: 18%; }
        .w-uni { width: 18%; }
        .w-status { width: 15%; }
        .ts-wrapper.single .ts-control::after { display: none !important; }
    </style>
</head>
<body class="antialiased">

    <div class="max-w-[1550px] mx-auto px-6 py-8">
        
        <div class="flex flex-col lg:flex-row justify-between items-center gap-8 mb-10">
            
            <div class="flex items-center gap-7 w-full lg:w-auto">
                <img src="https://i.imgur.com/7QcgJj0.png" alt="Logo" class="h-24 w-auto object-contain">
                <div>
                    <h1 class="text-4xl font-black text-slate-900 uppercase tracking-tighter leading-tight">
                        DASHBOARD PENGIRIMAN LAPORAN
                    </h1>
                    <p class="text-xl font-bold text-slate-500 italic uppercase tracking-wide mt-1">
                        Pusat Pelayanan Pendanaan Personal dan Operasional Pendidikan (P4OP)
                    </p>
                </div>
            </div>

            <div class="flex flex-col items-end gap-3 w-full lg:w-auto">
                <div class="flex gap-5 w-full md:w-auto">
                    <div class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm w-48">
                        <p class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-1 text-center">LAPORAN PM</p>
                        <div class="flex justify-center items-baseline gap-1">
                            <span id="percent-pm" class="text-3xl font-black text-emerald-600">0%</span>
                            <span class="text-[11px] text-slate-400 font-bold italic uppercase tracking-tighter">Sent</span>
                        </div>
                        <div class="w-full bg-slate-100 h-2 rounded-full mt-2 overflow-hidden">
                            <div id="bar-pm" class="bg-emerald-500 h-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm w-48">
                        <p class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-1 text-center">LAPORAN KK</p>
                        <div class="flex justify-center items-baseline gap-1">
                            <span id="percent-kk" class="text-3xl font-black text-blue-600">0%</span>
                            <span class="text-[11px] text-slate-400 font-bold italic uppercase tracking-tighter">Sent</span>
                        </div>
                        <div class="w-full bg-slate-100 h-2 rounded-full mt-2 overflow-hidden">
                            <div id="bar-kk" class="bg-blue-500 h-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <p class="text-[12px] text-slate-400 font-extrabold italic pr-1">
                    Data otomatis terupdate setiap 30 menit.
                </p>
            </div>
        </div>

        <div class="bg-white rounded-2xl p-7 shadow-sm border border-slate-200 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6 items-end">
                <div class="md:col-span-7">
                    <label class="block text-sm font-bold text-slate-700 uppercase tracking-widest mb-3 ml-1">PERGURUAN TINGGI</label>
                    <div class="search-container">
                        <select id="uni-filter" autocomplete="off"></select>
                    </div>
                </div>
                <div class="md:col-span-3">
                    <label class="block text-sm font-bold text-slate-700 uppercase tracking-widest mb-3 ml-1">FILTER STATUS</label>
                    <select id="completeness-filter" onchange="fetchData()" class="w-full bg-white border border-slate-200 rounded-xl px-4 h-[52px] text-base font-bold focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                        <option value="all">SEMUA LAPORAN</option>
                        <option value="complete">LAPORAN LENGKAP</option>
                        <option value="incomplete">LAPORAN BELUM LENGKAP</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <button onclick="downloadExcel()" class="w-full bg-slate-900 hover:bg-black text-white font-black h-[52px] rounded-xl transition-all shadow-lg flex items-center justify-center gap-2 text-xs uppercase tracking-widest">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        UNDUH DATA
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table id="main-data-table">
                    <thead>
                        <tr class="bg-slate-50 border-b border-slate-200 text-center uppercase tracking-widest">
                            <th class="w-no px-2 py-6 font-black text-slate-700">No</th>
                            <th class="w-mhs px-5 py-6 font-black text-slate-700 text-left">Identitas Mahasiswa</th>
                            <th class="w-prodi px-5 py-6 font-black text-slate-700 text-left">Program Studi</th>
                            <th class="w-uni px-5 py-6 font-black text-slate-700 text-left">Perguruan Tinggi</th>
                            <th class="w-status px-2 py-6 font-black text-slate-700">Laporan PM</th>
                            <th class="w-status px-2 py-6 font-black text-slate-700">Laporan KK</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="divide-y divide-slate-100 font-bold italic"></tbody>
                </table>
            </div>
            <div id="loading" class="hidden py-24 flex justify-center"><div class="animate-spin rounded-full h-12 w-12 border-4 border-slate-100 border-t-blue-600"></div></div>
            <div id="empty" class="hidden py-24 text-center text-slate-400 font-black uppercase text-sm tracking-widest">Data tidak ditemukan</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://tbuesvfdhqjbpoeuktkw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRidWVzdmZkaHFqYnBvZXVrdGt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1ODkxNDUsImV4cCI6MjA4NTE2NTE0NX0.HGZ0K1AfzsRucXxpfihc1uOy18AC9k77CbBg_e9Hhj0';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const TOTAL_TARGET = 16920;
        let tsSelector;
        let currentFilteredData = [];

        async function updateGlobalStats() {
            const { count: countPM } = await supabaseClient.from('data_laporan').select('*', { count: 'exact', head: true }).eq('PENGABDIAN', true);
            const { count: countKK } = await supabaseClient.from('data_laporan').select('*', { count: 'exact', head: true }).eq('KEPEMIMPINAN', true);

            const percentPM = ((countPM / TOTAL_TARGET) * 100).toFixed(1);
            const percentKK = ((countKK / TOTAL_TARGET) * 100).toFixed(1);

            document.getElementById('percent-pm').innerText = percentPM + '%';
            document.getElementById('bar-pm').style.width = percentPM + '%';
            document.getElementById('percent-kk').innerText = percentKK + '%';
            document.getElementById('bar-kk').style.width = percentKK + '%';
        }

        async function initUniversitas() {
            const { data } = await supabaseClient.from('data_laporan').select('UNIVERSITAS');
            if (data) {
                const unis = [...new Set(data.map(i => i.UNIVERSITAS))].filter(Boolean).sort();
                const selectEl = document.getElementById('uni-filter');
                selectEl.innerHTML = '<option value="">Cari Perguruan Tinggi...</option>';
                unis.forEach(u => { const opt = document.createElement('option'); opt.value = u; opt.textContent = u; selectEl.appendChild(opt); });
                if(tsSelector) tsSelector.destroy();
                tsSelector = new TomSelect("#uni-filter", { create: false, allowEmptyOption: true, onChange: function() { fetchData(); } });
            }
        }

        async function fetchData() {
            const body = document.getElementById('data-table-body');
            const loading = document.getElementById('loading');
            const empty = document.getElementById('empty');
            body.innerHTML = ''; loading.classList.remove('hidden'); empty.classList.add('hidden');

            const selectedUni = document.getElementById('uni-filter').value;
            const filterType = document.getElementById('completeness-filter').value;

            let query = supabaseClient.from('data_laporan').select('*').order('NO', { ascending: true });
            if (selectedUni) query = query.eq('UNIVERSITAS', selectedUni);

            const { data, error } = await query;
            loading.classList.add('hidden');
            if (error || !data || data.length === 0) { empty.classList.remove('hidden'); return; }

            let filteredData = data;
            if (filterType === 'complete') filteredData = data.filter(i => i.PENGABDIAN === true && i.KEPEMIMPINAN === true);
            else if (filterType === 'incomplete') filteredData = data.filter(i => i.PENGABDIAN !== true || i.KEPEMIMPINAN !== true);

            if (filteredData.length === 0) { empty.classList.remove('hidden'); return; }
            currentFilteredData = filteredData;

            body.innerHTML = filteredData.map(row => `
                <tr class="hover:bg-slate-50 transition-all border-b border-slate-50">
                    <td class="text-center font-black text-slate-400 text-sm">${row.NO || '-'}</td>
                    <td class="px-5">
                        <div class="font-black text-slate-800 uppercase leading-tight text-[15px] not-italic">${row.NAMA}</div>
                        <div class="text-[12px] text-slate-400 font-black mt-1 tracking-wider uppercase not-italic leading-none">NIM: ${row.NIM}</div>
                    </td>
                    <td class="px-5 text-slate-600 leading-snug not-italic text-[14px]">${row["PROGRAM STUDI"] || '-'}</td>
                    <td class="px-5">
                        <span class="text-[13px] font-black text-blue-700 bg-blue-50 px-3 py-2 rounded-lg uppercase block w-fit border border-blue-100 not-italic leading-tight">${row.UNIVERSITAS}</span>
                    </td>
                    <td class="text-center px-3">
                        <span class="block w-full py-3 rounded-xl text-[11px] font-black tracking-widest shadow-sm not-italic ${row.PENGABDIAN === true ? 'bg-emerald-500 text-white' : 'bg-rose-500 text-white'}">
                            ${row.PENGABDIAN === true ? 'SUDAH KIRIM' : 'BELUM KIRIM'}
                        </span>
                    </td>
                    <td class="text-center px-3">
                        <span class="block w-full py-3 rounded-xl text-[11px] font-black tracking-widest shadow-sm not-italic ${row.KEPEMIMPINAN === true ? 'bg-emerald-500 text-white' : 'bg-rose-500 text-white'}">
                            ${row.KEPEMIMPINAN === true ? 'SUDAH KIRIM' : 'BELUM KIRIM'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function downloadExcel() {
            if (currentFilteredData.length === 0) { alert("Tidak ada data untuk diunduh."); return; }
            const excelData = currentFilteredData.map(row => ({
                "NO": row.NO, "NAMA MAHASISWA": row.NAMA, "NIM": row.NIM, "PROGRAM STUDI": row["PROGRAM STUDI"], "PERGURUAN TINGGI": row.UNIVERSITAS,
                "LAPORAN PM": row.PENGABDIAN ? "SUDAH KIRIM" : "BELUM KIRIM", "LAPORAN KK": row.KEPEMIMPINAN ? "SUDAH KIRIM" : "BELUM KIRIM"
            }));
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Laporan");
            XLSX.writeFile(wb, `Laporan_P4OP_${new Date().getTime()}.xlsx`);
        }

        document.addEventListener('DOMContentLoaded', () => { 
            initUniversitas(); 
            fetchData();
            updateGlobalStats();
        });
    </script>
</body>
</html>
