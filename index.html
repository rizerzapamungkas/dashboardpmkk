<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pengiriman Laporan - P4OP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { background-color: #f8fafc; font-family: 'Plus Jakarta Sans', sans-serif; color: #1e293b; }
        
        /* Search Bar Styling */
        .ts-wrapper .ts-control { 
            border-radius: 0.75rem !important; 
            padding: 0 12px 0 45px !important; 
            border: 1px solid #e2e8f0 !important;
            min-height: 48px !important;
            display: flex; align-items: center; font-size: 14px !important;
        }

        .search-container { position: relative; }
        .search-container::before {
            content: ""; position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
            width: 20px; height: 20px; z-index: 10; pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
        }

        /* Responsive & Table Alignment */
        @media (max-width: 768px) {
            thead { display: none; }
            tr { display: block; margin-bottom: 1rem; border: 1px solid #e2e8f0; border-radius: 1rem; background: white; padding: 1rem; }
            td { display: flex; justify-content: space-between; align-items: center; border: none !important; padding: 0.5rem 0 !important; text-align: right !important; width: 100% !important; }
            td::before { content: attr(data-label); font-weight: 800; text-transform: uppercase; font-size: 10px; color: #94a3b8; text-align: left; }
        }

        table { table-layout: fixed; width: 100%; border-collapse: collapse; }
        th { vertical-align: middle !important; text-align: center !important; font-size: 13px !important; }
        td { vertical-align: middle !important; word-wrap: break-word; overflow-wrap: break-word; padding: 12px 10px !important; font-size: 15px !important; }
        
        .w-no { width: 45px; } 
        .w-mhs { width: 22%; }
        .w-prodi { width: 18%; }
        .w-uni { width: 18%; }
        .w-status { width: 16%; }
        .ts-wrapper.single .ts-control::after { display: none !important; }
    </style>
</head>
<body class="antialiased">

    <div class="max-w-[1550px] mx-auto px-4 md:px-6 py-4 md:py-8">
        <div class="flex flex-col lg:flex-row justify-between items-center gap-6 mb-8">
            <div class="flex items-center gap-6 w-full lg:w-auto justify-center md:justify-start">
                <img src="https://i.imgur.com/7QcgJj0.png" alt="Logo" class="h-20 w-auto object-contain">
                <div>
                    <h1 class="text-3xl font-black text-slate-900 uppercase tracking-tighter leading-tight">DASHBOARD PENGIRIMAN LAPORAN</h1>
                    <p class="text-base font-bold text-slate-500 italic uppercase tracking-wide mt-1">Pusat Pelayanan Pendanaan Personal dan Operasional Pendidikan (P4OP)</p>
                </div>
            </div>

            <div class="flex flex-col items-center md:items-end gap-2 w-full lg:w-auto">
                <div class="flex gap-4 w-full md:w-auto">
                    <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm flex-1 md:w-44 text-center">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">LAPORAN PM</p>
                        <span id="percent-pm" class="text-2xl font-black text-emerald-600">0%</span>
                        <div class="w-full bg-slate-100 h-1.5 rounded-full mt-2 overflow-hidden"><div id="bar-pm" class="bg-emerald-500 h-full" style="width: 0%"></div></div>
                    </div>
                    <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm flex-1 md:w-44 text-center">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">LAPORAN KK</p>
                        <span id="percent-kk" class="text-2xl font-black text-blue-600">0%</span>
                        <div class="w-full bg-slate-100 h-1.5 rounded-full mt-2 overflow-hidden"><div id="bar-kk" class="bg-blue-500 h-full" style="width: 0%"></div></div>
                    </div>
                </div>
                <p class="text-[10px] text-slate-400 font-extrabold italic pr-1 uppercase">Data otomatis terupdate setiap 30 menit.</p>
            </div>
        </div>

        <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                <div class="md:col-span-7">
                    <label class="block text-sm font-bold text-slate-700 uppercase tracking-widest mb-3">PERGURUAN TINGGI</label>
                    <div class="search-container"><select id="uni-filter" autocomplete="off"></select></div>
                </div>
                <div class="md:col-span-3">
                    <label class="block text-sm font-bold text-slate-700 uppercase tracking-widest mb-3">FILTER STATUS</label>
                    <select id="completeness-filter" onchange="resetAndFetch()" class="w-full bg-white border border-slate-200 rounded-xl px-3 h-[48px] text-sm font-semibold focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                        <option value="all">SEMUA LAPORAN</option>
                        <option value="complete">LAPORAN LENGKAP</option>
                        <option value="incomplete">LAPORAN BELUM LENGKAP</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <button onclick="downloadExcel()" class="w-full bg-slate-900 hover:bg-black text-white font-bold h-[48px] rounded-xl shadow-md flex items-center justify-center gap-2 text-xs uppercase tracking-widest">
                        UNDUH DATA
                    </button>
                </div>
            </div>
        </div>

        <div class="md:bg-white md:rounded-3xl md:shadow-sm md:border md:border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table>
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr class="uppercase tracking-widest">
                            <th class="w-no px-2 py-6 font-black text-slate-700">No</th>
                            <th class="w-mhs px-5 py-6 font-black text-slate-700 text-left">Identitas Mahasiswa</th>
                            <th class="w-prodi px-5 py-6 font-black text-slate-700 text-left">Program Studi</th>
                            <th class="w-uni px-5 py-6 font-black text-slate-700 text-left">Perguruan Tinggi</th>
                            <th class="w-status px-2 py-6 font-black text-slate-700">Laporan PM</th>
                            <th class="w-status px-2 py-6 font-black text-slate-700">Laporan KK</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="divide-y divide-slate-100 font-bold italic"></tbody>
                </table>
            </div>

            <div class="bg-slate-50 px-6 py-4 flex flex-col md:flex-row items-center justify-between gap-4 border-t border-slate-200">
                <div class="text-xs font-bold text-slate-500 uppercase">Halaman <span id="current-page-text" class="text-slate-900">1</span></div>
                <div class="flex items-center gap-2">
                    <button onclick="changePage(-1)" id="prev-btn" class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-xs font-black disabled:opacity-30 disabled:cursor-not-allowed hover:bg-slate-50 transition-all">← SEBELUMNYA</button>
                    <button onclick="changePage(1)" id="next-btn" class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-xs font-black disabled:opacity-30 disabled:cursor-not-allowed hover:bg-slate-50 transition-all">SELANJUTNYA →</button>
                </div>
            </div>

            <div id="loading" class="py-24 flex justify-center hidden"><div class="animate-spin rounded-full h-12 w-12 border-4 border-slate-100 border-t-blue-600"></div></div>
            <div id="empty" class="py-24 text-center text-slate-400 font-black uppercase text-sm tracking-widest hidden">Data Kosong</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://tbuesvfdhqjbpoeuktkw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRidWVzdmZkaHFqYnBvZXVrdGt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1ODkxNDUsImV4cCI6MjA4NTE2NTE0NX0.HGZ0K1AfzsRucXxpfihc1uOy18AC9k77CbBg_e9Hhj0';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const TOTAL_TARGET = 16920;
        const PAGE_SIZE = 50;
        let currentPage = 0;
        let tsSelector, currentFilteredData = [];

        async function updateGlobalStats() {
            const { count: countPM } = await supabaseClient.from('data_laporan').select('*', { count: 'exact', head: true }).eq('PENGABDIAN', true);
            const { count: countKK } = await supabaseClient.from('data_laporan').select('*', { count: 'exact', head: true }).eq('KEPEMIMPINAN', true);
            const percentPM = ((countPM / TOTAL_TARGET) * 100).toFixed(1);
            const percentKK = ((countKK / TOTAL_TARGET) * 100).toFixed(1);
            document.getElementById('percent-pm').innerText = percentPM + '%';
            document.getElementById('bar-pm').style.width = percentPM + '%';
            document.getElementById('percent-kk').innerText = percentKK + '%';
            document.getElementById('bar-kk').style.width = percentKK + '%';
        }

        async function initUniversitas() {
            const { data } = await supabaseClient.from('data_laporan').select('UNIVERSITAS');
            if (data) {
                const unis = [...new Set(data.map(i => i.UNIVERSITAS))].filter(Boolean).sort();
                const selectEl = document.getElementById('uni-filter');
                selectEl.innerHTML = '<option value="">Cari Perguruan Tinggi...</option>';
                unis.forEach(u => { const opt = document.createElement('option'); opt.value = u; opt.textContent = u; selectEl.appendChild(opt); });
                if(tsSelector) tsSelector.destroy();
                tsSelector = new TomSelect("#uni-filter", { create: false, allowEmptyOption: true, onChange: resetAndFetch });
            }
        }

        function resetAndFetch() { currentPage = 0; fetchData(); }
        function changePage(delta) { currentPage += delta; if (currentPage < 0) currentPage = 0; fetchData(); window.scrollTo({ top: document.querySelector('table').offsetTop - 50, behavior: 'smooth' }); }

        async function fetchData() {
            const body = document.getElementById('data-table-body');
            const loading = document.getElementById('loading');
            const empty = document.getElementById('empty');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            body.innerHTML = ''; loading.classList.remove('hidden'); empty.classList.add('hidden');

            const start = currentPage * PAGE_SIZE;
            const end = start + PAGE_SIZE - 1;
            const selectedUni = document.getElementById('uni-filter').value;
            const filterType = document.getElementById('completeness-filter').value;

            let query = supabaseClient.from('data_laporan').select('*').order('NO', { ascending: true });
            if (selectedUni) query = query.eq('UNIVERSITAS', selectedUni);

            const { data, error } = await query.range(start, end);
            loading.classList.add('hidden');
            if (error || !data || data.length === 0) { empty.classList.remove('hidden'); nextBtn.disabled = true; return; }

            let filteredData = data;
            if (filterType === 'complete') filteredData = data.filter(i => i.PENGABDIAN === true && i.KEPEMIMPINAN === true);
            else if (filterType === 'incomplete') filteredData = data.filter(i => i.PENGABDIAN !== true || i.KEPEMIMPINAN !== true);

            currentFilteredData = filteredData;
            document.getElementById('current-page-text').innerText = currentPage + 1;
            prevBtn.disabled = (currentPage === 0);
            nextBtn.disabled = (data.length < PAGE_SIZE);

            body.innerHTML = filteredData.map(row => `
                <tr class="hover:bg-slate-50 border-b border-slate-50 transition-all">
                    <td data-label="No" class="text-center font-extrabold text-slate-400 text-sm">${row.NO || '-'}</td>
                    <td data-label="Identitas Mahasiswa" class="px-5">
                        <div class="font-bold text-slate-800 uppercase leading-tight text-[15px] not-italic">${row.NAMA}</div>
                        <div class="text-[12px] text-slate-400 font-black mt-1 tracking-wider not-italic uppercase leading-none text-xs">NIM: ${row.NIM}</div>
                    </td>
                    <td data-label="Program Studi" class="px-5 text-slate-600 leading-snug not-italic text-[15px]">${row["PROGRAM STUDI"] || '-'}</td>
                    <td data-label="Perguruan Tinggi" class="px-5">
                        <span class="text-[15px] font-bold text-blue-700 bg-blue-50 px-3 py-2 rounded-lg uppercase block w-fit border border-blue-100 not-italic leading-tight">${row.UNIVERSITAS}</span>
                    </td>
                    <td data-label="Laporan PM" class="text-center px-3">
                        <span class="block w-full py-3 rounded-xl text-[10px] font-black tracking-widest not-italic ${row.PENGABDIAN === true ? 'bg-emerald-500 text-white' : 'bg-rose-500 text-white'}">${row.PENGABDIAN === true ? 'SUDAH' : 'BELUM'}</span>
                    </td>
                    <td data-label="Laporan KK" class="text-center px-3">
                        <span class="block w-full py-3 rounded-xl text-[10px] font-black tracking-widest not-italic ${row.KEPEMIMPINAN === true ? 'bg-emerald-500 text-white' : 'bg-rose-500 text-white'}">${row.KEPEMIMPINAN === true ? 'SUDAH' : 'BELUM'}</span>
                    </td>
                </tr>
            `).join('');
        }

        async function downloadExcel() {
    // 1. Ambil nilai filter yang sedang aktif di UI
    const selectedUni = document.getElementById('uni-filter').value;
    const filterType = document.getElementById('completeness-filter').value;

    // Tampilkan loading sederhana atau ganti teks tombol agar user tahu proses sedang berjalan
    const originalBtnText = event.target.innerHTML;
    event.target.innerText = "PROSES...";
    event.target.disabled = true;

    // 2. Query ke Supabase TANPA .range() agar mengambil SEMUA data sesuai filter
    let query = supabaseClient
        .from('data_laporan')
        .select('*')
        .order('NO', { ascending: true });

    if (selectedUni) {
        query = query.eq('UNIVERSITAS', selectedUni);
    }

    const { data, error } = await query;

    if (error || !data || data.length === 0) {
        alert("Gagal mengambil data atau data kosong.");
        event.target.innerHTML = originalBtnText;
        event.target.disabled = false;
        return;
    }

    // 3. Terapkan Filter Status Kelengkapan (Lengkap/Belum Lengkap) pada hasil query
    let filteredDataForExcel = data;
    if (filterType === 'complete') {
        filteredDataForExcel = data.filter(i => i.PENGABDIAN === true && i.KEPEMIMPINAN === true);
    } else if (filterType === 'incomplete') {
        filteredDataForExcel = data.filter(i => i.PENGABDIAN !== true || i.KEPEMIMPINAN !== true);
    }

    // 4. Map data ke format Excel
    const excelData = filteredDataForExcel.map(row => ({
        "NO": row.NO,
        "IDENTITAS MAHASISWA": row.NAMA,
        "NIM": row.NIM,
        "PROGRAM STUDI": row["PROGRAM STUDI"],
        "PERGURUAN TINGGI": row.UNIVERSITAS,
        "LAPORAN PM": row.PENGABDIAN === true ? "SUDAH KIRIM" : "BELUM KIRIM",
        "LAPORAN KK": row.KEPEMIMPINAN === true ? "SUDAH KIRIM" : "BELUM KIRIM"
    }));

    // 5. Proses pembuatan file Excel
    const ws = XLSX.utils.json_to_sheet(excelData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Laporan Full Filter");

    const timestamp = new Date().getTime();
    XLSX.writeFile(wb, `Laporan_Full_P4OP_${timestamp}.xlsx`);

    // Kembalikan tombol ke kondisi normal
    event.target.innerHTML = originalBtnText;
    event.target.disabled = false;
}

        document.addEventListener('DOMContentLoaded', () => { initUniversitas(); fetchData(); updateGlobalStats(); });
    </script>
</body>
</html>
