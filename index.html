<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pengiriman Laporan - P4OP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { background-color: #f8fafc; font-family: 'Plus Jakarta Sans', sans-serif; color: #1e293b; }
        .ts-wrapper .ts-control { border-radius: 0.75rem !important; padding: 0 12px 0 45px !important; border: 1px solid #e2e8f0 !important; min-height: 52px !important; display: flex; align-items: center; font-size: 15px !important; }
        .search-container { position: relative; }
        .search-container::before { content: ""; position: absolute; left: 16px; top: 50%; transform: translateY(-50%); width: 22px; height: 22px; z-index: 10; pointer-events: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z' /%3E%3C/svg%3E"); background-repeat: no-repeat; }
        
        @media (max-width: 768px) { 
            thead { display: none; } 
            tr { display: block; margin-bottom: 1rem; border: 1px solid #e2e8f0; border-radius: 1rem; background: white; padding: 1rem; } 
            td { display: flex; justify-content: space-between; align-items: center; border: none !important; padding: 0.5rem 0 !important; text-align: right !important; width: 100% !important; } 
            td::before { content: attr(data-label); font-weight: 800; text-transform: uppercase; font-size: 10px; color: #94a3b8; text-align: left; } 
            
            /* Penyesuaian Navigasi HP agar tidak keluar box */
            #pagination-numbers button { padding: 0.4rem 0.6rem !important; min-width: 32px; font-size: 11px; }
            #prev-btn, #next-btn { padding: 0.4rem 0.6rem !important; font-size: 10px !important; }
            .bg-slate-50.px-6.py-4 { padding-left: 0.75rem !important; padding-right: 0.75rem !important; }
        }

        table { table-layout: fixed; width: 100%; border-collapse: collapse; }
        th { vertical-align: middle !important; text-align: center !important; font-size: 13px !important; }
        td { vertical-align: middle !important; word-wrap: break-word; overflow-wrap: break-word; padding: 14px 10px !important; font-size: 15px !important; }
        .w-no { width: 55px; } .w-mhs { width: 23%; } .w-prodi { width: 18%; } .w-uni { width: 18%; } .w-status { width: 15%; }
        .ts-wrapper.single .ts-control::after { display: none !important; }
    </style>
</head>
<body class="antialiased">
    <div class="max-w-[1550px] mx-auto px-6 py-8">
        <div class="flex flex-col lg:flex-row justify-between items-center gap-8 mb-10">
            <div class="flex items-center gap-7 w-full lg:w-auto">
                <img src="https://i.imgur.com/7QcgJj0.png" alt="Logo" class="hidden lg:block h-24 w-auto object-contain">
                <div>
                    <h1 class="text-4xl font-black text-slate-900 uppercase tracking-tighter leading-tight">DASHBOARD PENGIRIMAN LAPORAN</h1>
                    <p class="text-xl font-bold text-slate-500 italic uppercase mt-1">Pusat Pelayanan Pendanaan Personal dan Operasional Pendidikan (P4OP)</p>
                </div>
            </div>
            <div class="flex flex-col items-end gap-3 w-full lg:w-auto">
                <div class="flex gap-5 w-full md:w-auto">
                    <div class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm flex-1 md:w-48 text-center">
                        <p class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-1">LAPORAN PM</p>
                        <span id="percent-pm" class="text-3xl font-black text-emerald-600">0%</span>
                        <div class="w-full bg-slate-100 h-2 rounded-full mt-2 overflow-hidden">
                            <div id="bar-pm" class="bg-emerald-500 h-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm flex-1 md:w-48 text-center">
                        <p class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-1">LAPORAN KK</p>
                        <span id="percent-kk" class="text-3xl font-black text-blue-600">0%</span>
                        <div class="w-full bg-slate-100 h-2 rounded-full mt-2 overflow-hidden">
                            <div id="bar-kk" class="bg-blue-500 h-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <p class="text-[12px] text-slate-400 font-extrabold italic pr-1 uppercase text-right">Data otomatis terupdate setiap 30 menit.</p>
            </div>
        </div>

        <div class="bg-white rounded-2xl p-7 shadow-sm border border-slate-200 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6 items-end">
                <div class="md:col-span-7">
                    <label class="block text-sm font-bold text-slate-700 uppercase tracking-widest mb-3 ml-1">PERGURUAN TINGGI</label>
                    <div class="search-container"><select id="uni-filter" autocomplete="off"></select></div>
                </div>
                <div class="md:col-span-3">
                    <label class="block text-sm font-bold text-slate-700 uppercase tracking-widest mb-3 ml-1">FILTER STATUS</label>
                    <select id="completeness-filter" onchange="resetAndFetch()" class="w-full bg-white border border-slate-200 rounded-xl px-4 h-[52px] text-base font-bold focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                        <option value="all">SEMUA LAPORAN</option>
                        <option value="complete">LAPORAN LENGKAP</option>
                        <option value="incomplete">LAPORAN BELUM LENGKAP</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <button id="download-btn" onclick="downloadExcel()" class="w-full bg-slate-900 hover:bg-black text-white font-black h-[52px] rounded-xl shadow-lg flex items-center justify-center gap-2 text-xs uppercase tracking-widest">UNDUH DATA <br> DARI FILTER</button>
                </div>
            </div>
        </div>

        <div class="bg-slate-50 px-6 py-4 flex flex-col md:flex-row items-center justify-between gap-4 border border-b-0 border-slate-200 rounded-t-3xl">
            <div class="text-xs font-bold text-slate-500 uppercase tracking-widest">
                Menampilkan <span id="data-count-text" class="text-slate-900">0</span> data dari <span id="total-data-text" class="text-slate-900">0</span> data
            </div>
            <div class="flex items-center gap-2">
                <button onclick="changePage(-1)" id="prev-btn" class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-xs font-black disabled:opacity-30 disabled:cursor-not-allowed hover:bg-slate-50 transition-all uppercase">← Prev</button>
                <div id="pagination-numbers" class="flex gap-1"></div>
                <button onclick="changePage(1)" id="next-btn" class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-xs font-black disabled:opacity-30 disabled:cursor-not-allowed hover:bg-slate-50 transition-all uppercase">Next →</button>
            </div>
        </div>

        <div class="bg-white rounded-b-3xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table id="main-data-table">
                    <thead>
                        <tr class="bg-slate-50 border-b border-slate-200 text-center uppercase tracking-widest text-slate-700">
                            <th class="w-no px-2 py-6 font-black">No</th>
                            <th class="w-mhs px-5 py-6 font-black text-left">Identitas Mahasiswa</th>
                            <th class="w-prodi px-5 py-6 font-black text-left">Program Studi</th>
                            <th class="w-uni px-5 py-6 font-black text-left">Perguruan Tinggi</th>
                            <th class="w-status px-2 py-6 font-black">Laporan PM</th>
                            <th class="w-status px-2 py-6 font-black">Laporan KK</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="divide-y divide-slate-100 font-bold italic"></tbody>
                </table>
            </div>
            <div id="loading" class="hidden py-24 flex justify-center"><div class="animate-spin rounded-full h-12 w-12 border-4 border-slate-100 border-t-blue-600"></div></div>
            <div id="empty" class="hidden py-24 text-center text-slate-400 font-black uppercase text-sm tracking-widest">Data tidak ditemukan</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://tbuesvfdhqjbpoeuktkw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRidWVzdmZkaHFqYnBvZXVrdGt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1ODkxNDUsImV4cCI6MjA4NTE2NTE0NX0.HGZ0K1AfzsRucXxpfihc1uOy18AC9k77CbBg_e9Hhj0';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const TOTAL_TARGET = 16920;
        const PAGE_SIZE = 50;
        let currentPage = 0;
        let totalRows = 0;
        let tsSelector;

        async function updateGlobalStats() {
            const { count: countPM } = await supabaseClient.from('data_laporan').select('*', { count: 'exact', head: true }).eq('PENGABDIAN', true);
            const { count: countKK } = await supabaseClient.from('data_laporan').select('*', { count: 'exact', head: true }).eq('KEPEMIMPINAN', true);
            const pPM = ((countPM / TOTAL_TARGET) * 100).toFixed(1);
            const pKK = ((countKK / TOTAL_TARGET) * 100).toFixed(1);
            document.getElementById('percent-pm').innerText = pPM + '%';
            document.getElementById('bar-pm').style.width = pPM + '%';
            document.getElementById('percent-kk').innerText = pKK + '%';
            document.getElementById('bar-kk').style.width = pKK + '%';
        }

async function initUniversitas() {
    const daftarKampus = [
        "UNIVERSITAS NEGERI JAKARTA", "UNIVERSITAS ISLAM NEGERI SYARIF HIDAYATULLAH", "UNIVERSITAS GUNADARMA",
        "UNIVERSITAS PEMBANGUNAN NASIONAL VETERAN JAKARTA", "UNIVERSITAS MUHAMMADIYAH PROF DR HAMKA", "UNIVERSITAS NASIONAL",
        "POLITEKNIK NEGERI JAKARTA", "UNIVERSITAS MERCU BUANA", "POLITEKNIK NEGERI MEDIA KREATIF", "INSTITUT PERTANIAN BOGOR",
        "UNIVERSITAS SULTAN AGENG TIRTAYASA", "UNIVERSITAS INDONESIA", "UNIVERSITAS BRAWIJAYA", "UNIVERSITAS PENDIDIKAN INDONESIA",
        "UNIVERSITAS SINGAPERBANGSA KARAWANG", "UNIVERSITAS ISLAM NEGERI SULTAN MAULANA HASANUDDIN BANTEN", "UNIVERSITAS PANCASILA",
        "UNIVERSITAS DIPONEGORO", "UNIVERSITAS JENDERAL SOEDIRMAN", "UNIVERSITAS NEGERI SEMARANG", "INSTITUT TEKNOLOGI SUMATERA",
        "UNIVERSITAS NEGERI SURABAYA", "SEKOLAH TINGGI ILMU EKONOMI TRISAKTI", "UNIVERSITAS TRISAKTI", "UNIVERSITAS PADJADJARAN",
        "UNIVERSITAS ISLAM NEGERI SIBER SYEKH NURJATI CIREBON", "UNIVERSITAS TARUMANAGARA", "UNIVERSITAS LAMPUNG",
        "UNIVERSITAS ISLAM NEGERI WALISONGO SEMARANG", "UNIVERSITAS SEBELAS MARET", "UNIVERSITAS GADJAH MADA",
        "UNIVERSITAS NEGERI MALANG", "UNIVERSITAS UDAYANA", "UNIVERSITAS ISLAM NEGERI SUNAN GUNUNG DJATI", "UNIVERSITAS NEGERI YOGYAKARTA",
        "UNIVERSITAS ISLAM NEGERI RADEN MAS SAID SURAKARTA", "UNIVERSITAS TIDAR", "UNIVERSITAS ISLAM NEGERI PROFESOR KIAI HAJI SAIFUDDIN ZUHRI PURWOKERTO",
        "UNIVERSITAS BINA SARANA INFORMATIKA", "UNIVERSITAS PEMBANGUNAN NASIONAL VETERAN YOGYAKARTA", "UNIVERSITAS NEGERI PADANG",
        "UNIVERSITAS ISLAM NEGERI SALATIGA", "UNIVERSITAS ANDALAS", "UNIVERSITAS SILIWANGI", "INSTITUT SENI INDONESIA YOGYAKARTA",
        "UNIVERSITAS AIRLANGGA", "UNIVERSITAS PENDIDIKAN GANESHA", "UNIVERSITAS ISLAM NEGERI SUNAN KALIJAGA",
        "UNIVERSITAS PEMBANGUNAN NASIONAL VETERAN JAWA TIMUR", "INSTITUT TEKNOLOGI BANDUNG", "UNIVERSITAS ISLAM NEGERI K.H. ABDURRAHMAN WAHID PEKALONGAN",
        "UNIVERSITAS ISLAM NEGERI MAULANA MALIK IBRAHIM", "INSTITUT SENI INDONESIA SURAKARTA", "UNIVERSITAS ISLAM NEGERI RADEN INTAN LAMPUNG",
        "UNIVERSITAS JEMBER", "UNIVERSITAS TRUNOJOYO", "UNIVERSITAS SRIWIJAYA", "INSTITUT PARIWISATA TRISAKTI", "POLITEKNIK NEGERI LAMPUNG",
        "UNIVERSITAS ESA UNGGUL", "INSTITUT TEKNOLOGI SEPULUH NOPEMBER", "UNIVERSITAS BINA NUSANTARA", "UNIVERSITAS KATOLIK INDONESIA ATMA JAYA",
        "POLITEKNIK NEGERI INDRAMAYU", "UNIVERSITAS HASANUDDIN", "UNIVERSITAS ISLAM NEGERI SJECH M. DJAMIL DJAMBEK BUKITTINGGI",
        "UNIVERSITAS NEGERI MEDAN", "UNIVERSITAS SUMATERA UTARA", "POLITEKNIK NEGERI MADIUN", "POLITEKNIK NEGERI MALANG",
        "UNIVERSITAS BENGKULU", "UNIVERSITAS ISLAM NEGERI IMAM BONJOL PADANG", "INSTITUT AGAMA ISLAM NEGERI KEDIRI", "POLITEKNIK NEGERI BALI",
        "POLITEKNIK NEGERI BANDUNG", "INSTITUT SENI BUDAYA INDONESIA BANDUNG", "UNIVERSITAS ISLAM NEGERI MAHMUD YUNUS BATUSANGKAR",
        "UNIVERSITAS ISLAM NEGERI SUNAN AMPEL", "UNIVERSITAS RIAU", "UNIVERSITAS TANJUNGPURA", "POLITEKNIK NEGERI CILACAP",
        "POLITEKNIK PERKAPALAN NEGERI SURABAYA", "UNIVERSITAS BANGKA BELITUNG", "INSTITUT AGAMA ISLAM NEGERI METRO",
        "UNIVERSITAS ISLAM NEGERI RADEN FATAH PALEMBANG", "UNIVERSITAS JAMBI", "UNIVERSITAS KRISTEN INDONESIA", "UNIVERSITAS PATTIMURA",
        "UNIVERSITAS SYIAH KUALA", "INSTITUT AGAMA ISLAM NEGERI PONOROGO", "INSTITUT SENI INDONESIA DENPASAR", "POLITEKNIK NEGERI JEMBER",
        "POLITEKNIK NEGERI PADANG", "POLITEKNIK NEGERI SEMARANG", "UNIVERSITAS AL-AZHAR INDONESIA", "UNIVERSITAS ISLAM NEGERI ALAUDDIN MAKASSAR",
        "UNIVERSITAS ISLAM NEGERI SAYYID ALI RAHMATULLAH TULUNGAGUNG", "UNIVERSITAS MATARAM", "UNIVERSITAS MUHAMMADIYAH JAKARTA",
        "UNIVERSITAS MULTIMEDIA NUSANTARA JAKARTA", "IAIN PONTIANAK", "INSTITUT AGAMA ISLAM NEGERI KUDUS", "INSTITUT AGAMA KRISTEN NEGERI TARUTUNG",
        "INSTITUT SENI INDONESIA PADANG PANJANG", "INSTITUT TEKNOLOGI KALIMANTAN", "POLITEKNIK ELEKTRONIKA NEGERI SURABAYA",
        "POLITEKNIK MANUFAKTUR BANDUNG", "UNIVERSITAS ISLAM NEGERI DATOKARAMA PALU", "UNIVERSITAS LAMBUNG MANGKURAT", "UNIVERSITAS MALIKUSSALEH",
        "UNIVERSITAS MARITIM RAJA ALI HAJI (UMRAH)", "UNIVERSITAS MULAWARMAN", "UNIVERSITAS NEGERI MAKASSAR", "UNIVERSITAS SAM RATULANGI"
    ];
    const selectEl = document.getElementById('uni-filter');
    selectEl.innerHTML = '<option value="">Cari Perguruan Tinggi...</option>';
    daftarKampus.sort().forEach(u => { 
        const opt = document.createElement('option'); 
        opt.value = u; 
        opt.textContent = u; 
        selectEl.appendChild(opt); 
    });
    if(tsSelector) tsSelector.destroy();
    tsSelector = new TomSelect("#uni-filter", { 
        create: false, 
        allowEmptyOption: true, 
        maxOptions: 200, 
        onChange: resetAndFetch 
    });
}

        function resetAndFetch() { currentPage = 0; fetchData(); }
        function changePage(delta) { currentPage += delta; if (currentPage < 0) currentPage = 0; fetchData(); window.scrollTo({ top: document.getElementById('main-data-table').offsetTop - 200, behavior: 'smooth' }); }

        async function fetchData() {
            const body = document.getElementById('data-table-body');
            const loading = document.getElementById('loading');
            const empty = document.getElementById('empty');
            body.innerHTML = ''; loading.classList.remove('hidden'); empty.classList.add('hidden');
            const selectedUni = document.getElementById('uni-filter').value;
            const filterType = document.getElementById('completeness-filter').value;
            const start = currentPage * PAGE_SIZE;
            const end = start + PAGE_SIZE - 1;
            let query = supabaseClient.from('data_laporan').select('*', { count: 'exact' });
            if (selectedUni) query = query.eq('UNIVERSITAS', selectedUni);
            if (filterType === 'complete') query = query.eq('PENGABDIAN', true).eq('KEPEMIMPINAN', true);
            else if (filterType === 'incomplete') query = query.or('PENGABDIAN.eq.false,KEPEMIMPINAN.eq.false');
            const { data, error, count } = await query.order('NO', { ascending: true }).range(start, end);
            loading.classList.add('hidden');
            if (error || !data || data.length === 0) { 
                empty.classList.remove('hidden'); 
                totalRows = 0; document.getElementById('total-data-text').innerText = "0"; document.getElementById('data-count-text').innerText = "0";
                renderPageNumbers(); return; 
            }
            totalRows = count || 0;
            document.getElementById('total-data-text').innerText = totalRows.toLocaleString();
            document.getElementById('data-count-text').innerText = data.length;
            document.getElementById('prev-btn').disabled = (currentPage === 0);
            document.getElementById('next-btn').disabled = (end >= totalRows - 1);
            renderPageNumbers();
            body.innerHTML = data.map(row => `
                <tr class="hover:bg-slate-50 transition-all border-b border-slate-50">
                    <td data-label="No" class="text-center font-black text-slate-400 text-sm">${row.NO || '-'}</td>
                    <td data-label="Identitas Mahasiswa" class="px-5 flex flex-col items-end md:items-start md:table-cell">
                        <div class="font-black text-slate-800 uppercase leading-tight text-[15px] not-italic text-right md:text-left">${row.NAMA}</div>
                        <div class="text-[12px] text-slate-400 font-black mt-1 uppercase not-italic leading-none text-right md:text-left">NIM: ${row.NIM}</div>
                    </td>
                    <td data-label="Program Studi" class="px-5 text-slate-600 leading-snug not-italic text-[15px]">${row["PROGRAM STUDI"] || '-'}</td>
                    <td data-label="Perguruan Tinggi" class="px-5">
                        <span class="text-[15px] font-bold text-blue-700 bg-blue-50 px-3 py-2 rounded-lg uppercase block w-fit border border-blue-100 not-italic leading-tight">${row.UNIVERSITAS}</span>
                    </td>
                    <td data-label="Laporan PM" class="text-center px-3">
                        <span class="block w-full py-3 rounded-xl text-[10px] font-black tracking-widest not-italic text-center ${row.PENGABDIAN === true ? 'bg-emerald-500 text-white' : 'bg-rose-500 text-white'}">${row.PENGABDIAN === true ? 'SUDAH' : 'BELUM'}</span>
                    </td>
                    <td data-label="Laporan KK" class="text-center px-3">
                        <span class="block w-full py-3 rounded-xl text-[10px] font-black tracking-widest not-italic text-center ${row.KEPEMIMPINAN === true ? 'bg-emerald-500 text-white' : 'bg-rose-500 text-white'}">${row.KEPEMIMPINAN === true ? 'SUDAH' : 'BELUM'}</span>
                    </td>
                </tr>
            `).join('');
        }

        function renderPageNumbers() {
            const container = document.getElementById('pagination-numbers');
            container.innerHTML = '';
            const totalPages = Math.ceil(totalRows / PAGE_SIZE);
            if(totalPages <= 1) return;
            let start = Math.max(0, currentPage - 2);
            let end = Math.min(totalPages, start + 5);
            if (end - start < 5) start = Math.max(0, end - 5);
            for (let i = start; i < end; i++) {
                if(i < 0) continue;
                const btn = document.createElement('button');
                btn.innerText = i + 1;
                btn.className = `px-3 py-2 rounded-lg text-xs font-bold transition-all ${i === currentPage ? 'bg-slate-900 text-white shadow-md' : 'bg-white border border-slate-200 text-slate-600 hover:bg-slate-50'}`;
                btn.onclick = () => { currentPage = i; fetchData(); window.scrollTo({ top: document.getElementById('main-data-table').offsetTop - 200, behavior: 'smooth' }); };
                container.appendChild(btn);
            }
        }

        async function downloadExcel() {
            const btn = document.getElementById('download-btn');
            const originalText = btn.innerHTML;
            const selectedUni = document.getElementById('uni-filter').value;
            const filterType = document.getElementById('completeness-filter').value;
            btn.innerText = "PROSES..."; btn.disabled = true;
            let query = supabaseClient.from('data_laporan').select('*');
            if (selectedUni) query = query.eq('UNIVERSITAS', selectedUni);
            if (filterType === 'complete') query = query.eq('PENGABDIAN', true).eq('KEPEMIMPINAN', true);
            else if (filterType === 'incomplete') query = query.or('PENGABDIAN.eq.false,KEPEMIMPINAN.eq.false');
            const { data, error } = await query.order('NO', { ascending: true });
            if (error || !data || data.length === 0) { alert("Gagal mengambil data."); btn.innerHTML = originalText; btn.disabled = false; return; }
            const excelData = data.map(row => ({ "NO": row.NO, "IDENTITAS MAHASISWA": row.NAMA, "NIM": row.NIM, "PROGRAM STUDI": row["PROGRAM STUDI"], "PERGURUAN TINGGI": row.UNIVERSITAS, "LAPORAN PM": row.PENGABDIAN ? "SUDAH KIRIM" : "BELUM KIRIM", "LAPORAN KK": row.KEPEMIMPINAN ? "SUDAH KIRIM" : "BELUM KIRIM" }));
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Laporan");
            XLSX.writeFile(wb, `Laporan_P4OP_Filter_${Date.now()}.xlsx`);
            btn.innerHTML = originalText; btn.disabled = false;
        }
        document.addEventListener('DOMContentLoaded', () => { initUniversitas(); fetchData(); updateGlobalStats(); });
    </script>
</body>
</html>
